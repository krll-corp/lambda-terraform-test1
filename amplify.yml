version: 1
backend:
  phases:
    build:
      commands:
        - echo "Skipping backend deploy in Amplify Console (handled by GitHub Actions)"
frontend:
  phases:
    preBuild:
      commands:
        - mkdir -p dist
    build:
      commands:
        - |
          cat > dist/index.html <<'HTML'
          <!doctype html>
          <meta charset="utf-8" />
          <meta name="viewport" content="width=device-width,initial-scale=1" />
          <title>DB Response</title>
          <pre id="out"></pre>
          <script src="/config.js"></script>
          <script>
            (async () => {
              const fallbackUrl = "https://pz7iziac2xdwumllpfp6x7psgu0pehgk.lambda-url.eu-central-1.on.aws/";
              const baseUrl = (window.__LAMBDA_URL__ || "").trim() || fallbackUrl;
              const target = new URL(baseUrl);
              const incomingParams = new URLSearchParams(window.location.search);

              for (const [key, value] of incomingParams.entries()) {
                target.searchParams.set(key, value);
              }

              try {
                const response = await fetch(target.toString(), { method: "GET" });
                const text = await response.text();
                document.getElementById("out").textContent = text;
              } catch (err) {
                document.getElementById("out").textContent = String(err);
              }
            })();
          </script>
          HTML
        - |
          node -e 'const fs=require("fs"); const url=process.env.LAMBDA_URL || ""; fs.writeFileSync("dist/config.js", `window.__LAMBDA_URL__=${JSON.stringify(url)};`);'
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
